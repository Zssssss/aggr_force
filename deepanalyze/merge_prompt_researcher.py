from datetime import datetime
import json
def get_prompt(query,ref_assume,subtitle,ref_data=None):
    from jinja2 import Template
    prompt_template = Template("""
基于以下数据:
{{ ref_data }}


用户提出的问题是“{{question}}”
任务说明
针对问题，做出了“{{ subtitle }}”的假设并给出了需要进行验证的内容：
{{ref_assume}}


请基于数据对假设做验证，生成具体验证报告。

在生成时，请注意以下几点：
● 当前时间: {{ CURRENT_TIME }}。
● 并非数据都与需验证的内容相关，你需要结合需求与自身知识，对数据进行甄别、筛选。
● 不要遗漏关键数据信息

输出格式
● 以 markdown 格式提供结构化响应。
● 包含以下部分：

    ○ 问题陈述：为了清晰起见，重述问题。
    ○ 主要内容：围绕“{{ question }}”中的假设“{{ subtitle }}”，整理数据验证的相关信息。
    ○ 结论：根据收集到的信息，对问题提供一个综合性的验证结论。
""")  

    return prompt_template.render(
        ref_data=ref_data,
        question=query,
        CURRENT_TIME=datetime.now().strftime('%Y年%m月%d日'),
        subtitle=subtitle,
        ref_assume=ref_assume                
    )

def process_assume(json_dict_list):
    res = []
    for i,item in enumerate(json_dict_list):
        question,verified,reason = item['问题'], item['是否被验证'], item.get("原因","")
        res.append(f"""[参考内容 {i} begin]
[需验证内容 begin] {question} [需验证内容 end]
[是否被验证 begin] {verified} [是否被验证 end]
[参考内容 {i} end]""" if not reason else f"""[参考内容 {i} begin]
[需验证内容 begin] {question} [需验证内容 end]
[是否被验证 begin] {verified} [是否被验证 end]
[初步原因 begin] {reason} [初步原因 end]
[参考内容 {i} end]""")
    return '\n'.join(res)
  
 
if __name__ == "__main__":
    query="用户停留时长下降"
    ref_data = open("aggregated_data.txt").read()
    
    planner_res = """```json
{
  "场景": "用户停留时长下降分析任务规划",
  "假设映射": [
    {
      "假设": "内容吸引力下降导致用户提前离开",
      "权重": "0.3",
      "验证项": [
        {
          "问题": "非流式内容完读率是否下降",
          "是否被验证": "是",
          "原因": "使用智搜tab天级非流式完读率数据（文件：智搜tab天级非流式百分比完读率_20251212_112521.xlsx），分析高完读区间（≥80%）占比变化趋势，低完读率表明内容吸引力不足"
        },
        {
          "问题": "用户对结果满意度是否降低",
          "是否被验证": "否",
          "MCP工具": [
            "用户反馈分析工具"
          ],
          "参数": {
            "反馈类型": "负面评价比例",
            "时间段": "20251201-20251207"
          }
        },
        {
          "问题": "分享和互动行为是否减少",
          "是否被验证": "是",
          "原因": "使用智搜分享发博数据（文件：智搜分享发博数据图_智搜分享卡片数据_20251212_112549.xlsx），验证有效阅读量/互动量下降趋势"
        }
      ]
    },
    {
      "假设": "对话质量下降导致多轮交互减少",
      "权重": "0.25",
      "验证项": [
        {
          "问题": "人均对话轮次是否下降",
          "是否被验证": "是",
          "原因": "使用评论场景进入对话页数据（文件：对话页-评论场景数据_评论场景进入对话页数据_20251212_112704.xlsx），计算对话轮次/回流uv比值的变化"
        },
        {
          "问题": "主动提问量是否减少",
          "是否被验证": "是",
          "原因": "使用多轮对话数据（文件：多轮对话数据_进入对话页和主动提问pv_20251212_112718.xlsx），观察主动提问pv的下降趋势"
        },
        {
          "问题": "追问行为是否减少",
          "是否被验证": "否",
          "MCP工具": [
            "对话行为分析工具"
          ],
          "参数": {
            "行为类型": "追问率",
            "时间粒度": "按小时分析"
          }
        }
      ]
    },
    {
      "假设": "渠道来源变化引入低质量流量",
      "权重": "0.2",
      "验证项": [
        {
          "问题": "低停留时长渠道占比是否增加",
          "是否被验证": "是",
          "原因": "对比智搜分场景pv数据（文件：智搜分场景pv_智搜分来源pv_20251212_112300.xlsx）中各来源pv占比变化与停留时长关系"
        },
        {
          "问题": "新渠道用户停留时长是否偏低",
          "是否被验证": "否",
          "MCP工具": [
            "用户画像分析工具"
          ],
          "参数": {
            "维度": "渠道来源",
            "指标": "平均停留时长"
          }
        },
        {
          "问题": "渠道合作方质量是否下降",
          "是否被验证": "是",
          "原因": "分析渠道合作方数据（文件：渠道合作方数据_渠道分类型_20251212_112341.xlsx），观察低质量渠道（如小米sug）PV增长情况"
        }
      ]
    },
    {
      "假设": "技术问题导致体验降级",
      "权重": "0.15",
      "验证项": [
        {
          "问题": "命中风控率是否异常升高",
          "是否被验证": "是",
          "原因": "使用智搜命中风控数据（文件：智搜命中风控数据_智搜tab命中风控pv占比_20251212_112418.xlsx），观察整体命中风控pv占比变化"
        },
        {
          "问题": "页面加载时间是否增加",
          "是否被验证": "否",
          "MCP工具": [
            "前端性能监控工具"
          ],
          "参数": {
            "监控点": "首屏加载时间",
            "阈值": ">3s占比"
          }
        },
        {
          "问题": "错误率是否上升",
          "是否被验证": "否",
          "MCP工具": [
            "异常监控平台"
          ],
          "参数": {
            "错误类型": "接口500错误",
            "模块": "内容渲染模块"
          }
        }
      ]
    },
    {
      "假设": "用户结构变化影响整体指标",
      "权重": "0.1",
      "验证项": [
        {
          "问题": "新用户占比是否显著提高",
          "是否被验证": "是",
          "原因": "结合官方账号粉丝量数据（文件：官方账号粉丝量_官方账号每日新增粉丝量_20251212_112610.xlsx）和智搜MAU数据计算新用户占比"
        },
        {
          "问题": "核心用户留存率是否下降",
          "是否被验证": "是",
          "原因": "使用智搜留存指标（文件：智搜留存指标_智搜留存指标_20251212_112155.xlsx），观察7日留存率变化趋势"
        },
        {
          "问题": "用户设备类型分布是否变化",
          "是否被验证": "是",
          "原因": "分析智搜分手机端pv数据（文件：智搜分场景pv_智搜分手机端pv_20251212_112256.xlsx），iOS/Android用户占比变化"
        }
      ]
    }
  ]
}
```"""
    plan=json.loads(planner_res.strip().replace("```json","").replace("```",""))
    subtitle = plan['假设映射'][0]['假设']
    ref_assume = plan['假设映射'][0]['验证项']
    processed_ref_assume = process_assume(ref_assume)
    p=get_prompt(query,ref_data=ref_data,subtitle=subtitle,ref_assume=processed_ref_assume)
    print(p)